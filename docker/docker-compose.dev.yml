services:
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: deps
    container_name: unpload-api-dev
    working_dir: /app
    command: sh -c "cd packages/shared && npm run build && cd /app/apps/api && npx prisma generate && npx prisma db push && npm run dev"
    ports:
      - "4000:4000"
    environment:
      - DATABASE_URL=postgresql://unpload:unpload@db:5432/unpload
      - JWT_SECRET=dev-secret-do-not-use-in-prod
      - STORAGE_TYPE=local
      - STORAGE_PATH=/data/uploads
    volumes:
      - ../apps/api:/app/apps/api
      - ../packages/shared:/app/packages/shared
      - ../tsconfig.json:/app/tsconfig.json:ro
      - unpload_data_dev:/data/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - unpload-dev

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: deps
    container_name: unpload-web-dev
    working_dir: /app
    command: sh -c "cd apps/web && npm run dev"
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:4000
    volumes:
      - ../apps/web:/app/apps/web
      - ../packages/shared:/app/packages/shared
      - ../tsconfig.json:/app/tsconfig.json:ro
    depends_on:
      - api
    networks:
      - unpload-dev

  db:
    image: postgres:16-alpine
    container_name: unpload-db-dev
    environment:
      - POSTGRES_USER=unpload
      - POSTGRES_PASSWORD=unpload
      - POSTGRES_DB=unpload
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U unpload" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - unpload-dev

volumes:
  unpload_data_dev:
  postgres_data_dev:


networks:
  unpload-dev:
